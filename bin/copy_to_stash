#!/usr/bin/env python3
"""
copy_to_stash: Copy a Mu2e SAM dataset into the StashCache layout.

Files are read from SAM (disk or tape location) and copied with `cp` into:
    $MU2E_STASH_WRITE/datasets/<tier>/<owner>/<desc>/<dsconf>/<ext>/<filename>

Once present there they are accessible on the grid (CVMFS read path) and can
be used with `inloc: stash` in job configs.

Usage
-----
    copy_to_stash --dataset dts.mu2e.CeEndpoint.Run1Bab.art
    copy_to_stash --dataset dts.mu2e.CeEndpoint.Run1Bab.art --source disk --limit 10
    copy_to_stash --dataset dts.mu2e.CeEndpoint.Run1Bab.art --dry-run
    copy_to_stash --list dts.mu2e.CeEndpoint.Run1Bab.art

Environment variables
---------------------
    MU2E_STASH_WRITE  Write root (default: /pnfs/mu2e/persistent/stash)
    MU2E_STASH_READ   Read root  (default: /cvmfs/mu2e.osgstorage.org/pnfs/fnal.gov/usr/mu2e/persistent/stash)
"""

import argparse
import os
import sys

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils.stash_utils import (
    copy_dataset_to_stash,
    list_expected_paths,
    stash_read_root,
    stash_write_root,
)


def main():
    parser = argparse.ArgumentParser(
        description='Copy a Mu2e dataset into the StashCache layout.',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  copy_to_stash --dataset dts.mu2e.CeEndpoint.Run1Bab.art
  copy_to_stash --dataset dts.mu2e.CeEndpoint.Run1Bab.art --source disk --limit 10
  copy_to_stash --dataset dts.mu2e.CeEndpoint.Run1Bab.art --dry-run
  copy_to_stash --list dts.mu2e.CeEndpoint.Run1Bab.art
        """
    )
    parser.add_argument(
        '--dataset', metavar='DATASET',
        help='SAM dataset name to copy (e.g. dts.mu2e.CeEndpoint.Run1Bab.art)'
    )
    parser.add_argument(
        '--source', metavar='LOC', default='disk', choices=['disk', 'tape'],
        help='SAM location type to read from (default: disk)'
    )
    parser.add_argument(
        '--limit', metavar='N', type=int, default=None,
        help='Copy at most N files (useful for testing)'
    )
    parser.add_argument(
        '--dry-run', action='store_true',
        help='Print what would be copied without actually copying'
    )
    parser.add_argument(
        '--list', metavar='DATASET', dest='list_dataset',
        help='List expected stash read paths for a dataset (no copy)'
    )
    parser.add_argument(
        '--quiet', action='store_true',
        help='Suppress per-file progress output'
    )

    args = parser.parse_args()

    # --list mode: just print expected paths
    if args.list_dataset:
        paths = list_expected_paths(args.list_dataset)
        for p in paths:
            print(p)
        return 0

    if not args.dataset:
        parser.error('--dataset is required (or use --list)')

    print(f"Dataset : {args.dataset}")
    print(f"Source  : {args.source}")
    print(f"Write to: {stash_write_root()}/datasets/...")
    print(f"Read at : {stash_read_root()}/datasets/...")
    if args.limit:
        print(f"Limit   : {args.limit} files")
    if args.dry_run:
        print("Mode    : dry-run (no files will be copied)")
    print()

    n_copied = copy_dataset_to_stash(
        dataset=args.dataset,
        source_loc=args.source,
        limit=args.limit,
        dry_run=args.dry_run,
        verbose=not args.quiet,
    )

    return 0 if n_copied >= 0 else 1


if __name__ == '__main__':
    sys.exit(main())
