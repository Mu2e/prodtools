<!DOCTYPE html>
<html>
<head>
    <title>JSON Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .nav { margin-bottom: 20px; }
        .nav a { color: #007bff; text-decoration: none; margin-right: 15px; }
        select { width: 300px; padding: 5px; margin-bottom: 10px; }
        .CodeMirror { border: 1px solid #ddd; height: 400px; font-size: 0.9em; }
        button { background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .status { padding: 5px; margin: 5px 0; border-radius: 3px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
    </style>
</head>
<body>
    <h1>JSON Editor</h1>
    
    <div class="nav">
        <a href="/monitor">‚Üê Monitor</a>
        <a href="/json2jobdef">JobDesc Generator</a>
    </div>
    
    <select id="fileSelect">
        <option value="">Select JSON file...</option>
    </select>
    
    <textarea id="editor" placeholder="Select a file to edit..."></textarea>
    
        <div>
            <button id="saveBtn" onclick="save()">Save</button>
            <span id="readOnlyIndicator" style="display: none; color: #856404; background: #fff3cd; padding: 5px 10px; border-radius: 3px; margin-left: 10px;">
                Read-only
            </span>
        </div>
    
    <div id="status"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.js"></script>
    <script>
        let currentFile = null;
        let editor = null;
        
        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: 'application/json',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 2,
            tabSize: 2,
            foldGutter: true,
            gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
            extraKeys: {
                'Ctrl-S': save,
                'Ctrl-F': function(cm) { cm.execCommand('find'); }
            }
        });
        
        const params = new URLSearchParams(window.location.search);
        const initialFile = params.get('file') || '';
        let filesData = [];
        let isInitializing = true;
        
        function updateQuery(filePath) {
            const url = new URL(window.location);
            if (filePath) {
                url.searchParams.set('file', filePath);
            } else {
                url.searchParams.delete('file');
            }
            window.history.replaceState({}, '', url);
        }
        
        // Initial load
        fetch('/api/json-files')
            .then(r => r.json())
            .then(data => {
                filesData = data.files || [];
                const select = document.getElementById('fileSelect');
                filesData.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.path;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', function() {
                    if (isInitializing) return; // Ignore during initialization
                    const selected = this.value;
                    if (!selected) {
                        updateQuery('');
                        editor.setValue('');
                        setReadOnlyMode(true);
                        document.getElementById('readOnlyIndicator').style.display = 'none';
                        showStatus('Select a file to begin editing', 'info');
                        currentFile = null;
                        return;
                    }
                    loadFileByPath(selected, false, true);
                });
                
                const targetFile = initialFile;

                if (targetFile) {
                    const inDropdown = filesData.some(f => f.path === targetFile);
                    if (inDropdown) {
                        select.value = targetFile;
                        loadFileByPath(targetFile, false, false);
                    } else {
                        select.selectedIndex = 0; // Reset dropdown
                        loadFileByPath(targetFile, true, false);
                    }
                } else if (filesData.length > 0) {
                    const firstFile = filesData[0].path;
                    select.value = firstFile;
                    loadFileByPath(firstFile, false, true);
                }
                
                isInitializing = false; // Allow change events now
            });
        
        function setReadOnlyMode(isReadOnly) {
            editor.setOption('readOnly', isReadOnly);
            document.getElementById('saveBtn').disabled = isReadOnly;
            document.getElementById('readOnlyIndicator').style.display = isReadOnly ? 'inline' : 'none';
        }
        
        function loadFileByPath(filePath, readOnly = false, updateUrl = true) {
            if (!filePath) return;
            if (updateUrl) {
                updateQuery(filePath);
            }
            currentFile = filePath;
            showStatus('Loading...', 'info');
            
            if (readOnly) {
                const select = document.getElementById('fileSelect');
                select.selectedIndex = 0; // Reset to "Select JSON file..."
            }
            
            fetch('/api/json-file/' + encodeURIComponent(filePath))
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    return r.json();
                })
                .then(data => {
                    if (data.success) {
                        const content = data.content || '';
                        editor.setValue(content);
                        setReadOnlyMode(readOnly);
                        const status = readOnly ? 'Loaded: ' + filePath.split('/').pop() + ' (read-only)' : 'Loaded';
                        showStatus(status, 'success');
                    } else {
                        showStatus('Error: ' + data.error, 'error');
                    }
                })
                .catch(e => showStatus('Error: ' + e.message, 'error'));
        }
        
        function save() {
            if (!currentFile) return;
            
            fetch('/api/json-file/' + encodeURIComponent(currentFile), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: editor.getValue()})
            })
            .then(r => r.json())
            .then(data => showStatus(data.success ? 'Saved' : data.error, data.success ? 'success' : 'error'));
        }
        
        
        function showStatus(msg, type) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = 'status ' + type;
            setTimeout(() => status.textContent = '', 2000);
        }
    </script>
</body>
</html>
