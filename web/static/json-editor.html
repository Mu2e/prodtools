<!DOCTYPE html>
<html>
<head>
    <title>JSON Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .nav { margin-bottom: 20px; }
        .nav a { color: #007bff; text-decoration: none; margin-right: 15px; }
        select { width: 300px; padding: 5px; margin-bottom: 10px; }
        .CodeMirror { border: 1px solid #ddd; height: 400px; font-size: 0.9em; }
        .CodeMirror .cm-string { color: #a6e22e; }
        .CodeMirror .cm-number { color: #ae81ff; }
        .CodeMirror .cm-keyword { color: #f92672; }
        .CodeMirror .cm-property { color: #66d9ef; }
        .CodeMirror .cm-bracket { color: #f8f8f2; }
        .CodeMirror .cm-comma { color: #f8f8f2; }
        .CodeMirror .cm-colon { color: #f8f8f2; }
        button { background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .status { padding: 5px; margin: 5px 0; border-radius: 3px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
    </style>
</head>
<body>
    <h1>JSON Editor</h1>
    
    <div class="nav">
        <a href="/monitor">‚Üê Monitor</a>
        <a href="/json2jobdef">JobDesc Generator</a>
    </div>
    
    <select id="fileSelect" onchange="loadFile()">
        <option>Select JSON file...</option>
    </select>
    
    <textarea id="editor" placeholder="Select a file to edit..."></textarea>
    
        <div>
            <button onclick="save()">Save</button>
        </div>
    
    <div id="status"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.js"></script>
    <script>
        let currentFile = null;
        let editor = null;
        
        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: 'application/json',
            theme: 'monokai',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 2,
            tabSize: 2,
            foldGutter: true,
            gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
            extraKeys: {
                'Ctrl-S': function(cm) {
                    save();
                },
                'Ctrl-F': function(cm) {
                    cm.execCommand('find');
                }
            }
        });
        
        fetch('/api/json-files')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('fileSelect');
                data.files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.path;
                    select.appendChild(option);
                });
                // Auto-load the first file if available
                if (data.files.length > 0) {
                    // Check if a file was passed from JobDef generator
                    const selectedFile = sessionStorage.getItem('selectedJsonFile');
                    if (selectedFile && data.files.some(f => f.path === selectedFile)) {
                        select.value = selectedFile;
                        sessionStorage.removeItem('selectedJsonFile'); // Clear after use
                    } else {
                        select.value = data.files[0].path;
                    }
                    loadFile();
                }
            });
        
        function loadFile() {
            currentFile = document.getElementById('fileSelect').value;
            if (!currentFile) return;
            
            showStatus('Loading...', 'info');
            
            fetch('/api/json-file/' + encodeURIComponent(currentFile))
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.success) {
                        const content = data.content || '';
                        if (content.trim() === '') {
                            showStatus('File is empty', 'error');
                            editor.setValue('');
                        } else {
                            editor.setValue(content);
                            showStatus('Loaded', 'success');
                        }
                    } else {
                        showStatus('Error: ' + data.error, 'error');
                    }
                })
                .catch(e => {
                    showStatus('Error: ' + e.message, 'error');
                    console.error('Load error:', e);
                });
        }
        
        function save() {
            if (!currentFile) return;
            
            fetch('/api/json-file/' + encodeURIComponent(currentFile), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: editor.getValue()})
            })
            .then(r => r.json())
            .then(data => showStatus(data.success ? 'Saved' : data.error, data.success ? 'success' : 'error'));
        }
        
        
        function showStatus(msg, type) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = 'status ' + type;
            setTimeout(() => status.textContent = '', 2000);
        }
    </script>
</body>
</html>
